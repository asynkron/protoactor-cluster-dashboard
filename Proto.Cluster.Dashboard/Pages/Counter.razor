@page "/counter"
@using Proto.Cluster.Gossip
@inject ActorSystem System
<PageTitle>Counter</PageTitle>
<style>
    .box {        
        border:1px solid #ffffff30;        
        padding: 4px;
        margin: 4px;
        border-radius: 3px;
        font-size: small;
    }
   
</style>


<MudText Typo="Typo.h2">Gossip State</MudText>

@if (_state != null)
{
    var i = 0;
    foreach (var x in _state.Members)
    {
        <MudPaper Class="pa-4 my-2">
            <MemberStateWidget MemberId="@x.Key" State="@x.Value"></MemberStateWidget>

        </MudPaper>
        i++;
    }
}

@code {
    private GossipState? _state;
    private readonly CancellationTokenSource _cts = new();
    private bool _disposed;
    private Member[] _members;

    protected override async Task OnInitializedAsync()
    {
        _ = Task.Run(async () =>
        {
            while (!_cts.Token.IsCancellationRequested)
            {
                _state = await System.Cluster().Gossip.GetStateSnapshot();
                _members = System.Cluster().MemberList.GetAllMembers();
                await InvokeAsync(StateHasChanged);
                await Task.Delay(100);
            }
        }, _cts.Token);
        await base.OnInitializedAsync();
    }

    public void Dispose()
    {
        Dispose(true);
    }

    public void Dispose(bool disposing)
    {
        if (_disposed)
        {
            return;
        }
        if (disposing)
        {
            _cts.Cancel();
        }
        _disposed = true;
    }

}